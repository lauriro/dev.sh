#!/bin/sh

. ./gitserv

is_admin

ver() {
	git describe --long --dirty 2>/dev/null || \
	echo "g$(git rev-parse --short HEAD)$(git diff --no-ext-diff --quiet --exit-code || echo '-dirty')"
}


case $1 in
print)
	printf "Version: %s\n" "$(ver)"
	printf "PWD: %s\n" "$PWD"
	printf "ROOT: %s\n" "$ROOT"
	printf "LOG: %s\n" "$LOG"
	printf "KEYS: %s\n" "$KEYS"
	cat users.conf
	;;
update)
	printf "Old version: %s\n" "$(ver)"
	git pull
	test -n "$3" && git reset --hard "$3"
	printf "New version: %s\n" "$(ver)"
	;;
reset)
	printf "" > $FILE
	;;
*)
	# Prepare .ssh folder and files
	mkdir -p $(dirname $KEYS)
	chmod 700 $(dirname $KEYS)
	touch $KEYS
	chmod 600 $KEYS

	mkdir -p "$ROOT"

	test -w "$KEYS" || die "File '$KEYS' is not writable"

	# sudo chsh -s /usr/bin/git-shell gituser

	;;
esac



